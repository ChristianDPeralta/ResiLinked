<!DOCTYPE html>
<html lang="tl">
<head>
  <meta charset="UTF-8">
  <title>Hanap ng Trabaho | ResiLinked</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="logo.png">
  <link rel="stylesheet" href="fade.css" />
  <style>
    :root {
      --primary: #38a169;
      --primary-dark: #2f855a;
      --header-bg: #2b6cb0;
      --panel: #fff;
      --bg: #f4f6f8;
      --border: #a3c5e8;
      --text-dark: #333;
      --text-light: #2b6cb0;
      --radius: 10px;
      --shadow: 0 4px 32px rgba(0,0,0,0.10);
      --header-height: 70px;
      --header-padding-x: 2rem;
      --logo-size: 38px;
      --nav-btn-width: 110px;
      --nav-btn-height: 38px;
      --nav-btn-font-size: 1.08em;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text-dark);
      min-height: 100vh;
    }
    header {
      background: var(--header-bg);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      height: var(--header-height);
      min-height: var(--header-height);
      padding: 0 var(--header-padding-x);
      box-sizing: border-box;
      font-size: var(--nav-btn-font-size);
      font-weight: 600;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.09);
      position: relative;
      z-index: 10;
    }
    .branding {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .branding img {
      width: var(--logo-size);
      height: var(--logo-size);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.14);
      background: #fff;
      object-fit: contain;
    }
    header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 1px;
    }
    header h1 a {
      color: white;
      text-decoration: none;
      transition: color 0.2s;
    }
    header h1 a:hover {
      color: #cbe6ff;
    }
    nav {
      display: flex;
      align-items: center;
      height: var(--header-height);
      gap: 0.5rem;
    }
    nav a {
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      text-decoration: none;
      background: var(--header-bg);
      margin-left: 1.5rem;
      font-weight: 500;
      font-size: var(--nav-btn-font-size);
      transition: background 0.2s, color 0.2s;
      border-radius: 7px;
      width: var(--nav-btn-width);
      height: var(--nav-btn-height);
      min-width: var(--nav-btn-width);
      min-height: var(--nav-btn-height);
      box-sizing: border-box;
      border: none;
      outline: none;
      text-align: center;
    }
    nav a:hover, nav a.active {
      background: #2460aa;
      color: #cbe6ff;
      text-decoration: none;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 30px 25px;
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-width: 320px;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .tab-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .tab-btn {
      background: #f9fafb;
      border: none;
      border-radius: 8px;
      padding: 12px 28px;
      font-weight: 600;
      font-size: 1.05em;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--header-bg);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid transparent;
    }
    .tab-btn.active {
      background: var(--header-bg);
      color: #fff;
      box-shadow: 0 4px 12px rgba(43, 108, 176, 0.3);
    }
    .tab-btn:hover:not(.active) {
      background: #e8f4fd;
      border-color: var(--header-bg);
    }
    .searchbar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #e6f2ff;
      border-radius: 10px;
      padding: 3px 15px 3px 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      min-width: 280px;
      flex-shrink: 0;
    }
    .searchbar input {
      background: none;
      border: none;
      outline: none;
      font-size: 1.05em;
      padding: 8px 6px;
      width: 100%;
      min-width: 220px;
      background: transparent;
      color: var(--text-dark);
    }
    .searchbar input::placeholder {
      color: var(--header-bg);
      opacity: 0.8;
    }
    .searchbar .search-icon {
      font-size: 1.1em;
      color: var(--header-bg);
    }
    .jobs-grid, .applied-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-top: 10px;
    }
    .job-card {
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.1rem 1rem 0.9rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 1em;
      align-items: flex-start;
      min-height: 94px;
      border: none;
      transition: transform 0.13s, box-shadow 0.15s;
      cursor: pointer;
    }
    .job-card:hover {
      transform: translateY(-3px) scale(1.04);
      box-shadow: 0 4px 16px rgba(56,161,105,0.12);
    }
    .job-title {
      font-size: 1.17rem;
      font-weight: 700;
      margin-bottom: 2px;
      color: var(--header-bg);
      text-shadow: 0 2px 8px rgba(0,0,0,0.13);
    }
    .job-positions, .job-salary {
      font-size: 1rem;
      color: var(--text-light);
      font-weight: 500;
    }
    .apply-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.8rem 2rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 6px;
      font-size: 1rem;
      box-shadow: 0 2px 12px rgba(56,161,105,0.15);
      transition: background 0.2s;
    }
    .apply-btn:hover {
      background: var(--primary-dark);
    }
    .cancel-btn {
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 0.6rem 1.5rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      font-size: 0.9rem;
      box-shadow: 0 2px 12px rgba(220,53,69,0.15);
      transition: background 0.2s;
      width: 100%;
    }
    .cancel-btn:hover {
      background: #c82333;
    }
    .status-chip {
      background: #b3dbff;
      border-radius: 10px;
      padding: 3px 12px;
      font-size: 0.97em;
      color: var(--header-bg);
      margin-top: 8px;
      text-align: center;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .filters-section {
      background: #f7fbff;
      border-radius: var(--radius);
      padding: 1.8rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .filters-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--header-bg);
      margin-bottom: 1.2rem;
      text-align: left;
    }
    .filters-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1.5rem;
      margin-bottom: 1.2rem;
      align-items: end;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      min-width: 0; /* Allow content to shrink */
    }
    .filter-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.3rem;
      white-space: nowrap;
    }
    .filter-input, .filter-select {
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: white;
      font-size: 1rem;
      color: var(--text-dark);
      outline: none;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      width: 100%;
      box-sizing: border-box;
    }
    .filter-input:focus, .filter-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.1);
    }
    .price-range {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    .price-range input {
      flex: 1;
      min-width: 80px;
    }
    .price-range span {
      font-weight: 600;
      color: var(--text-dark);
      padding: 0 0.3rem;
    }
    .filter-buttons {
      display: flex;
      gap: 1.2rem;
      margin-top: 1.5rem;
      justify-content: flex-start;
    }
    .filter-btn {
      padding: 10px 20px;
      border-radius: 7px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-btn.primary {
      background: var(--primary);
      color: white;
    }
    .filter-btn.primary:hover {
      background: var(--primary-dark);
    }
    .filter-btn.secondary {
      background: #e2e8f0;
      color: var(--text-dark);
    }
    .filter-btn.secondary:hover {
      background: #cbd5e0;
    }
    .job-details {
      font-size: 0.9rem;
      color: var(--text-light);
      margin: 0.5rem 0;
    }
    .job-location {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .job-skills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin: 0.5rem 0;
    }
    .skill-tag {
      background: #e6f2ff;
      color: var(--header-bg);
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s ease;
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 600px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
      animation: slideIn 0.3s ease;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--header-bg);
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #999;
      padding: 5px;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .close-btn:hover {
      background: #f0f0f0;
      color: #333;
    }
    .modal-body {
      line-height: 1.6;
    }
    .modal-section {
      margin-bottom: 1.5rem;
    }
    .modal-section h3 {
      color: var(--header-bg);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
    }
    .employer-info {
      background: #f7fbff;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .no-jobs {
      text-align: center;
      padding: 3rem;
      color: #666;
      font-size: 1.1rem;
    }
    .dropdown-row {
      margin-top: 22px;
      text-align: left;
      display: flex;
      justify-content: flex-end;
    }
    .dropdown {
      padding: 10px 16px;
      border-radius: 7px;
      border: 1px solid var(--border);
      background: #f7fbff;
      font-size: 1rem;
      color: var(--header-bg);
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideIn {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @media (max-width: 900px) {
      .container {
        max-width: 95vw;
        margin: 20px auto;
        padding: 20px 15px;
      }
      .filters-row {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .price-range {
        flex-direction: column;
        gap: 0.5rem;
        align-items: stretch;
      }
      .price-range input {
        min-width: auto;
      }
    }
    @media (max-width: 600px) {
      .tabs {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }
      .tab-buttons {
        justify-content: center;
      }
      .searchbar {
        margin-top: 0;
        width: 100%;
        justify-content: center;
        min-width: auto;
      }
      .searchbar input {
        min-width: 180px;
      }
      .jobs-grid, .applied-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .dropdown-row {
        margin-top: 20px;
        justify-content: center;
      }
      .filter-buttons {
        flex-direction: column;
        gap: 0.8rem;
      }
      .container {
        margin: 10px auto;
        padding: 15px 10px;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
        padding: 1rem 0.5rem;
        height: var(--header-height);
        min-height: var(--header-height);
      }
      .branding {
        margin-bottom: 0.7rem;
      }
      .branding img {
        width: 32px;
        height: 32px;
      }
      nav a {
        min-width: var(--nav-btn-width);
        min-height: var(--nav-btn-height);
        font-size: var(--nav-btn-font-size);
        margin-left: 0.5rem;
      }
    }
  </style>
</head>
<body class="fade-in">
  <header>
    <div class="branding">
      <img src="logo.png" alt="ResiLinked Logo" />
      <h1><a href="landing.html" class="logo-link">ResiLinked</a></h1>
    </div>
    <nav id="main-nav">
      <!-- Navigation will be dynamically inserted here -->
    </nav>
  </header>
  <div class="container">
    <div class="tabs">
      <div class="tab-buttons">
        <button class="tab-btn active" id="searchTab">HANAP NG TRABAHO</button>
        <button class="tab-btn" id="appliedTab">MGA NA-APPLYAN NA TRABAHO</button>
      </div>
      <div class="searchbar">
        <span class="search-icon">&#128269;</span>
        <input type="text" id="searchInput" placeholder="MAGSEARCH NG TRABAHO">
      </div>
    </div>

    <!-- Enhanced Filters Section -->
    <div class="filters-section" id="filtersSection">
      <div class="filters-title">Mag-filter ng mga Trabaho</div>
      <div class="filters-row">
        <div class="filter-group">
          <label class="filter-label">Lokasyon/Barangay</label>
          <select class="filter-select" id="locationFilter">
            <option value="">Lahat ng lugar</option>
            <option value="Barangay 1">Barangay 1</option>
            <option value="Barangay 2">Barangay 2</option>
            <option value="Barangay 3">Barangay 3</option>
            <option value="Barangay 4">Barangay 4</option>
            <option value="Barangay 5">Barangay 5</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Uri ng Trabaho</label>
          <select class="filter-select" id="skillFilter">
            <option value="">Lahat ng uri</option>
            <option value="Kasambahay">Kasambahay</option>
            <option value="Tagalinis">Tagalinis</option>
            <option value="Tagapagluto">Tagapagluto</option>
            <option value="Tagapinta">Tagapinta</option>
            <option value="Tagapag-alaga ng bata">Tagapag-alaga ng bata</option>
            <option value="Tagatinda">Tagatinda</option>
            <option value="Tagatanim">Tagatanim</option>
            <option value="Layout artist">Layout artist</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Sweldo (‚Ç±)</label>
          <div class="price-range">
            <input type="number" class="filter-input" id="minPrice" placeholder="Min">
            <span>-</span>
            <input type="number" class="filter-input" id="maxPrice" placeholder="Max">
          </div>
        </div>
      </div>
      <div class="filter-buttons">
        <button class="filter-btn primary" id="applyFilters">I-apply ang Filter</button>
        <button class="filter-btn secondary" id="clearFilters">I-clear ang Filter</button>
      </div>
    </div>

    <div class="jobs-grid" id="jobsList">
      <!-- Jobs will be populated dynamically -->
    </div>
    <div class="applied-grid" id="appliedList" style="display:none;">
      <!-- Applied jobs will be populated dynamically -->
    </div>
    <div class="dropdown-row">
      <select class="dropdown" id="sortFilter">
        <option value="datePosted,desc">Pinakabago</option>
        <option value="price,desc">Pinakamataas na sweldo</option>
        <option value="price,asc">Pinakamababang sweldo</option>
        <option value="applicants,desc">Maraming nag-apply</option>
      </select>
    </div>
  </div>

  <!-- Job Details Modal -->
  <div class="modal" id="jobModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalJobTitle">Job Title</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <h3>Detalye ng Trabaho</h3>
          <p id="modalJobDescription">Job description will appear here...</p>
        </div>
        
        <div class="modal-section">
          <h3>Sweldo</h3>
          <p id="modalJobPrice" style="font-size: 1.2rem; font-weight: 600; color: var(--primary);"></p>
        </div>
        
        <div class="modal-section">
          <h3>Lokasyon</h3>
          <p id="modalJobLocation"></p>
        </div>
        
        <div class="modal-section">
          <h3>Mga Kinakailangang Kasanayan</h3>
          <div id="modalJobSkills" class="job-skills"></div>
        </div>
        
        <div class="modal-section">
          <h3>Petsa ng Post</h3>
          <p id="modalJobDate"></p>
        </div>
        
        <div class="employer-info">
          <h3>Impormasyon ng Employer</h3>
          <p><strong>Pangalan:</strong> <span id="modalEmployerName"></span></p>
          <p><strong>Mga nag-apply:</strong> <span id="modalApplicantsCount"></span></p>
        </div>
        
        <div style="margin-top: 2rem; text-align: center;">
          <button class="apply-btn" id="modalApplyBtn" style="font-size: 1.1rem; padding: 1rem 3rem;">
            MAG-APPLY SA TRABAHONG ITO
          </button>
        </div>
      </div>
    </div>
  </div>
<script>
// --- Enhanced job search with filters and modal ---
const API_BASE = 'http://localhost:5000/api';
let currentJobs = [];
let currentFilters = {
  location: '',
  skill: '',
  minPrice: '',
  maxPrice: '',
  search: '',
  sortBy: 'datePosted',
  order: 'desc'
};

document.addEventListener('DOMContentLoaded', () => {
  initializeRoleBasedUI();
  initializeEventListeners();
  loadJobs();
});

function initializeRoleBasedUI() {
  const userData = JSON.parse(localStorage.getItem('userData') || '{}');
  const isEmployer = userData.userType === 'employer';
  const appliedTab = document.getElementById('appliedTab');
  
  // Hide applied tab for employers
  if (isEmployer) {
    appliedTab.style.display = 'none';
    // Add a note for employers
    const tabButtons = document.querySelector('.tab-buttons');
    const employerNote = document.createElement('div');
    employerNote.style.cssText = 'color: #666; font-size: 0.9rem; margin-left: 1rem; align-self: center;';
    employerNote.textContent = 'Para sa applications, gamitin ang Employer Dashboard';
    tabButtons.appendChild(employerNote);
  }
}

function initializeEventListeners() {
  // Tab switching
  const searchTab = document.getElementById('searchTab');
  const appliedTab = document.getElementById('appliedTab');
  const jobsList = document.getElementById('jobsList');
  const appliedList = document.getElementById('appliedList');
  const filtersSection = document.getElementById('filtersSection');

  searchTab.addEventListener('click', () => {
    searchTab.classList.add('active');
    appliedTab.classList.remove('active');
    jobsList.style.display = 'grid';
    appliedList.style.display = 'none';
    filtersSection.style.display = 'block';
    loadJobs();
  });

  appliedTab.addEventListener('click', () => {
    // Check if user can access applied jobs
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    const isEmployer = userData.userType === 'employer';
    
    if (isEmployer) {
      alert('Ang applied jobs tab ay para lamang sa mga employees. Gamitin ang inyong employer dashboard para makita ang mga applications na natanggap ninyo.');
      return;
    }
    
    if (userData.userType !== 'employee' && userData.userType !== 'both') {
      alert('Kailangan mo ng employee profile para makita ang mga job applications mo.');
      return;
    }
    
    searchTab.classList.remove('active');
    appliedTab.classList.add('active');
    jobsList.style.display = 'none';
    appliedList.style.display = 'grid';
    filtersSection.style.display = 'none';
    loadAppliedJobs();
  });

  // Filter functionality
  document.getElementById('applyFilters').addEventListener('click', applyFilters);
  document.getElementById('clearFilters').addEventListener('click', clearFilters);
  document.getElementById('searchInput').addEventListener('input', handleSearch);
  document.getElementById('sortFilter').addEventListener('change', handleSort);

  // Modal functionality
  document.getElementById('closeModal').addEventListener('click', closeModal);
  document.getElementById('jobModal').addEventListener('click', (e) => {
    if (e.target.id === 'jobModal') closeModal();
  });
}

// --- Filter functions ---
function applyFilters() {
  currentFilters.location = document.getElementById('locationFilter').value;
  currentFilters.skill = document.getElementById('skillFilter').value;
  currentFilters.minPrice = document.getElementById('minPrice').value;
  currentFilters.maxPrice = document.getElementById('maxPrice').value;
  loadJobs();
}

function clearFilters() {
  document.getElementById('locationFilter').value = '';
  document.getElementById('skillFilter').value = '';
  document.getElementById('minPrice').value = '';
  document.getElementById('maxPrice').value = '';
  currentFilters = {
    ...currentFilters,
    location: '',
    skill: '',
    minPrice: '',
    maxPrice: ''
  };
  loadJobs();
}

function handleSearch(e) {
  currentFilters.search = e.target.value;
  debounce(loadJobs, 500)();
}

function handleSort(e) {
  const [sortBy, order] = e.target.value.split(',');
  currentFilters.sortBy = sortBy;
  currentFilters.order = order;
  loadJobs();
}

// --- Load jobs from backend ---
async function loadJobs() {
  const jobsList = document.getElementById('jobsList');
  jobsList.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading jobs...</div>';
  
  try {
    const params = new URLSearchParams();
    if (currentFilters.location) params.append('barangay', currentFilters.location);
    if (currentFilters.skill) params.append('skill', currentFilters.skill);
    if (currentFilters.minPrice) params.append('minPrice', currentFilters.minPrice);
    if (currentFilters.maxPrice) params.append('maxPrice', currentFilters.maxPrice);
    if (currentFilters.search) params.append('search', currentFilters.search);
    params.append('sortBy', currentFilters.sortBy);
    params.append('order', currentFilters.order);

    const response = await fetch(`${API_BASE}/jobs/search?${params}`);
    const data = await response.json();
    
    if (data.success && data.data) {
      currentJobs = data.data;
      renderJobs(currentJobs);
    } else {
      // Fallback to sample jobs if backend is not available
      loadSampleJobs();
    }
  } catch (err) {
    console.error('Error loading jobs:', err);
    loadSampleJobs();
  }
}

function loadSampleJobs() {
  const sampleJobs = [
    {
      _id: '1',
      title: 'Kasambahay (all-around)',
      description: 'Naghahanap ng kasambahay na marunong maglinis ng bahay, magluto, at mag-alaga ng mga bata.',
      skillsRequired: ['Kasambahay', 'Paglalaba', 'Paglilinis'],
      barangay: 'Barangay 1',
      location: 'Barangay 1, Caloocan City',
      price: 15000,
      datePosted: new Date().toISOString(),
      postedBy: { firstName: 'Maria', lastName: 'Santos' },
      applicants: Array(64).fill(null)
    },
    {
      _id: '2',
      title: 'Tagalinis',
      description: 'Kailangan ng tagalinis para sa malaking opisina. May karanasan sa paggamit ng cleaning materials.',
      skillsRequired: ['Paglilinis', 'Maintenance'],
      barangay: 'Barangay 2',
      location: 'Barangay 2, Caloocan City',
      price: 12000,
      datePosted: new Date().toISOString(),
      postedBy: { firstName: 'Juan', lastName: 'Cruz' },
      applicants: Array(28).fill(null)
    },
    {
      _id: '3',
      title: 'Tagapagluto',
      description: 'Hinahanap namin ang bihasang kusinero para sa restaurant. Dapat marunong magluto ng Filipino dishes.',
      skillsRequired: ['Pagluluto', 'Kitchen Management'],
      barangay: 'Barangay 3',
      location: 'Barangay 3, Caloocan City',
      price: 17000,
      datePosted: new Date().toISOString(),
      postedBy: { firstName: 'Ana', lastName: 'Reyes' },
      applicants: Array(15).fill(null)
    },
    {
      _id: '4',
      title: 'Tagapinta',
      description: 'Naghahanap ng skilled painter para sa residential painting project. May sariling tools.',
      skillsRequired: ['Pagpipinta', 'Construction'],
      barangay: 'Barangay 4',
      location: 'Barangay 4, Caloocan City',
      price: 13000,
      datePosted: new Date().toISOString(),
      postedBy: { firstName: 'Roberto', lastName: 'Garcia' },
      applicants: Array(12).fill(null)
    },
    {
      _id: '5',
      title: 'Tagapag-alaga ng bata',
      description: 'Kailangan ng responsible na yaya para sa 2 bata (ages 3 at 5). Dapat may patience at caring.',
      skillsRequired: ['Childcare', 'First Aid'],
      barangay: 'Barangay 1',
      location: 'Barangay 1, Caloocan City',
      price: 14000,
      datePosted: new Date().toISOString(),
      postedBy: { firstName: 'Carmen', lastName: 'Lopez' },
      applicants: Array(20).fill(null)
    }
  ];
  
  // Apply current filters to sample jobs
  let filteredJobs = sampleJobs.filter(job => {
    if (currentFilters.location && job.barangay !== currentFilters.location) return false;
    if (currentFilters.skill && !job.skillsRequired.some(skill => skill.toLowerCase().includes(currentFilters.skill.toLowerCase()))) return false;
    if (currentFilters.minPrice && job.price < parseInt(currentFilters.minPrice)) return false;
    if (currentFilters.maxPrice && job.price > parseInt(currentFilters.maxPrice)) return false;
    if (currentFilters.search && !job.title.toLowerCase().includes(currentFilters.search.toLowerCase())) return false;
    return true;
  });

  // Apply sorting
  filteredJobs.sort((a, b) => {
    let aVal = a[currentFilters.sortBy];
    let bVal = b[currentFilters.sortBy];
    
    if (currentFilters.sortBy === 'applicants') {
      aVal = a.applicants.length;
      bVal = b.applicants.length;
    }
    
    if (currentFilters.order === 'desc') {
      return bVal > aVal ? 1 : -1;
    } else {
      return aVal > bVal ? 1 : -1;
    }
  });

  currentJobs = filteredJobs;
  renderJobs(filteredJobs);
}

function renderJobs(jobs) {
  const jobsList = document.getElementById('jobsList');
  
  if (!jobs || jobs.length === 0) {
    jobsList.innerHTML = `
      <div class="no-jobs">
        <h3>Walang nakitang trabaho</h3>
        <p>Subukan ang ibang filter o bumalik mamaya para sa mga bagong job posting.</p>
      </div>
    `;
    return;
  }

  jobsList.innerHTML = jobs.map(job => {
    // Check user role for apply button
    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
    const canApply = userData.userType === 'employee' || userData.userType === 'both';
    const isEmployer = userData.userType === 'employer';
    
    let applyButton = '';
    if (!localStorage.getItem('token')) {
      applyButton = '<button class="apply-btn" onclick="event.stopPropagation(); alert(\'Mag-login muna para makapag-apply.\'); window.location.href=\'login.html\'">MAG-LOGIN PARA MAG-APPLY</button>';
    } else if (isEmployer) {
      applyButton = '<button class="apply-btn" disabled style="background: #ccc; cursor: not-allowed;" title="Employers cannot apply to jobs">EMPLOYER ACCOUNT</button>';
    } else if (canApply) {
      applyButton = `<button class="apply-btn" onclick="event.stopPropagation(); applyToJob('${job._id}')">MAG-APPLY</button>`;
    } else {
      applyButton = '<button class="apply-btn" disabled style="background: #ccc; cursor: not-allowed;" title="Create employee profile to apply">KAILANGAN NG EMPLOYEE PROFILE</button>';
    }

    return `
      <div class="job-card" data-id="${job._id}" onclick="showJobDetails('${job._id}')">
        <div class="job-title">${job.title}</div>
        <div class="job-location">üìç ${job.barangay || job.location || 'Location not specified'}</div>
        <div class="job-details">${job.applicants ? job.applicants.length : 0} nag-apply na</div>
        <div class="job-salary">‚Ç±${job.price.toLocaleString()}</div>
        ${job.skillsRequired ? `
          <div class="job-skills">
            ${job.skillsRequired.slice(0, 3).map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
            ${job.skillsRequired.length > 3 ? `<span class="skill-tag">+${job.skillsRequired.length - 3} more</span>` : ''}
          </div>
        ` : ''}
        ${applyButton}
      </div>
    `;
  }).join('');
}

// --- Job details modal ---
function showJobDetails(jobId) {
  const job = currentJobs.find(j => j._id === jobId);
  if (!job) return;

  document.getElementById('modalJobTitle').textContent = job.title;
  document.getElementById('modalJobDescription').textContent = job.description || 'Walang description na available.';
  document.getElementById('modalJobPrice').textContent = `‚Ç±${job.price.toLocaleString()}`;
  document.getElementById('modalJobLocation').textContent = job.barangay || job.location || 'Location not specified';
  document.getElementById('modalJobDate').textContent = new Date(job.datePosted).toLocaleDateString('en-PH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  // Skills
  const skillsContainer = document.getElementById('modalJobSkills');
  if (job.skillsRequired && job.skillsRequired.length > 0) {
    skillsContainer.innerHTML = job.skillsRequired.map(skill => 
      `<span class="skill-tag">${skill}</span>`
    ).join('');
  } else {
    skillsContainer.innerHTML = '<span class="skill-tag">Hindi specified</span>';
  }
  
  // Employer info
  const employerName = job.postedBy ? `${job.postedBy.firstName} ${job.postedBy.lastName}` : 'Hindi available';
  document.getElementById('modalEmployerName').textContent = employerName;
  document.getElementById('modalApplicantsCount').textContent = job.applicants ? job.applicants.length : 0;
  
  // Apply button
  const modalApplyBtn = document.getElementById('modalApplyBtn');
  const userData = JSON.parse(localStorage.getItem('userData') || '{}');
  const canApply = userData.userType === 'employee' || userData.userType === 'both';
  const isEmployer = userData.userType === 'employer';
  
  if (!localStorage.getItem('token')) {
    modalApplyBtn.textContent = 'MAG-LOGIN PARA MAG-APPLY';
    modalApplyBtn.onclick = () => {
      alert('Mag-login muna para makapag-apply.');
      window.location.href = 'login.html';
    };
  } else if (isEmployer) {
    modalApplyBtn.textContent = 'HINDI AVAILABLE PARA SA EMPLOYERS';
    modalApplyBtn.disabled = true;
    modalApplyBtn.style.background = '#ccc';
    modalApplyBtn.style.cursor = 'not-allowed';
    modalApplyBtn.title = 'Employers cannot apply to jobs. Use your employer dashboard to find workers.';
    modalApplyBtn.onclick = () => {
      alert('Hindi ka makakag-apply sa mga trabaho bilang employer. Gamitin ang inyong employer dashboard para maghanap ng mga workers.');
    };
  } else if (canApply) {
    modalApplyBtn.textContent = 'MAG-APPLY SA TRABAHONG ITO';
    modalApplyBtn.disabled = false;
    modalApplyBtn.style.background = '';
    modalApplyBtn.style.cursor = 'pointer';
    modalApplyBtn.onclick = () => applyToJob(jobId);
  } else {
    modalApplyBtn.textContent = 'KAILANGAN NG EMPLOYEE PROFILE';
    modalApplyBtn.disabled = true;
    modalApplyBtn.style.background = '#ccc';
    modalApplyBtn.style.cursor = 'not-allowed';
    modalApplyBtn.onclick = () => {
      alert('Kailangan mo ng employee profile para makapag-apply sa mga trabaho.');
    };
  }
  
  // Show modal
  document.getElementById('jobModal').classList.add('show');
}

function closeModal() {
  document.getElementById('jobModal').classList.remove('show');
}

// --- Apply to job ---
async function applyToJob(jobId) {
  const token = localStorage.getItem('token');
  if (!token) {
    alert('Kailangan mo munang mag-login para makapag-apply.');
    window.location.href = 'login.html';
    return;
  }

  // Check user role - only employees can apply to jobs
  const userData = JSON.parse(localStorage.getItem('userData') || '{}');
  if (userData.userType === 'employer') {
    alert('Hindi ka makakag-apply sa mga trabaho bilang employer. Gumawa ka ng employee profile o maghanap ng mga workers sa inyong employer dashboard.');
    return;
  }
  
  if (userData.userType !== 'employee' && userData.userType !== 'both') {
    alert('Kailangan mo ng employee profile para makapag-apply sa mga trabaho.');
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/jobs/${jobId}/apply`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();
    
    if (response.ok) {
      alert(data.alert || 'Successfully applied to the job!');
      closeModal();
      loadJobs(); // Refresh jobs to update applicant count
    } else {
      alert(data.alert || data.message || 'Failed to apply to job');
    }
  } catch (err) {
    console.error('Error applying to job:', err);
    alert('May error sa pag-apply. Subukan ulit.');
  }
}

// --- Load applied jobs from backend ---
async function loadAppliedJobs() {
  const appliedList = document.getElementById('appliedList');
  appliedList.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading your applications...</div>';
  
  const token = localStorage.getItem('token');
  if (!token) {
    appliedList.innerHTML = '<div class="no-jobs"><h3>Kailangan mo munang mag-login</h3><p>Para makita ang mga job na na-applyan mo.</p></div>';
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/jobs/my-applications`, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      const applications = await response.json();
      renderAppliedJobs(applications);
    } else {
      appliedList.innerHTML = '<div class="no-jobs"><h3>Error loading applications</h3><p>Hindi ma-load ang mga na-applyan mo.</p></div>';
    }
  } catch (err) {
    console.error('Error loading applied jobs:', err);
    appliedList.innerHTML = '<div class="no-jobs"><h3>Error loading applications</h3><p>May problema sa connection.</p></div>';
  }
}

function renderAppliedJobs(applications) {
  const appliedList = document.getElementById('appliedList');
  
  if (!applications || applications.length === 0) {
    appliedList.innerHTML = '<div class="no-jobs"><h3>Wala pang na-apply</h3><p>Mag-apply sa mga available na jobs sa tab na "HANAP NG TRABAHO".</p></div>';
    return;
  }

  appliedList.innerHTML = applications.map(app => {
    const job = app.jobId || app;
    const applicant = app.applicants?.find(a => a.user === localStorage.getItem('userId'));
    const status = applicant?.status || app.status || 'pending';
    
    return `
      <div class="job-card">
        <div class="job-title">${job.title}</div>
        <div class="job-location">üìç ${job.barangay || job.location || 'Location not specified'}</div>
        <div class="job-salary">‚Ç±${job.price ? job.price.toLocaleString() : 'N/A'}</div>
        <div class="status-chip" style="background: ${getStatusColor(status)}">
          ${getStatusText(status)}
        </div>
        ${status === 'pending' ? `
          <button class="cancel-btn" onclick="cancelApplication('${job._id || app.jobId?._id}', '${app._id}')">
            Cancel Application
          </button>
        ` : ''}
      </div>
    `;
  }).join('');
}

function getStatusColor(status) {
  switch (status) {
    case 'accepted': return '#d4edda';
    case 'rejected': return '#f8d7da';
    default: return '#b3dbff';
  }
}

function getStatusText(status) {
  switch (status) {
    case 'accepted': return 'Accepted';
    case 'rejected': return 'Rejected';
    default: return 'Pending';
  }
}

// --- Cancel application function ---
async function cancelApplication(jobId, applicationId) {
  if (!confirm('Sigurado ka bang gusto mong i-cancel ang application mo sa job na ito?')) {
    return;
  }

  const token = localStorage.getItem('token');
  if (!token) {
    alert('Kailangan mo munang mag-login');
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/jobs/${jobId}/cancel-application`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();
    
    if (response.ok) {
      alert(data.alert || 'Successfully cancelled your application!');
      // Reload applied jobs to reflect the change
      loadAppliedJobs();
    } else {
      alert(data.alert || data.message || 'Hindi ma-cancel ang application. Subukan ulit.');
    }
  } catch (err) {
    console.error('Error cancelling application:', err);
    alert('May error sa pag-cancel. Subukan ulit.');
  }
}

// --- Utility functions ---
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
</script>

<!-- Include navigation -->
<script type="module" src="/src/navigation.js"></script>
<script type="module" src="/src/fade.js"></script>

</body>
</html>